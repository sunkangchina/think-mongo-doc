<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据库</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.87fd3165.css" as="style"><link rel="preload" href="/assets/js/app.f8d3940c.js" as="script"><link rel="preload" href="/assets/js/2.733019b2.js" as="script"><link rel="preload" href="/assets/js/12.ce7eb43c.js" as="script"><link rel="prefetch" href="/assets/js/10.fd193dcb.js"><link rel="prefetch" href="/assets/js/11.370144d3.js"><link rel="prefetch" href="/assets/js/13.1d12d874.js"><link rel="prefetch" href="/assets/js/14.781498e1.js"><link rel="prefetch" href="/assets/js/15.ec8787f1.js"><link rel="prefetch" href="/assets/js/16.b69d84d7.js"><link rel="prefetch" href="/assets/js/3.2c80fa4d.js"><link rel="prefetch" href="/assets/js/4.0dd8aefa.js"><link rel="prefetch" href="/assets/js/5.14db227c.js"><link rel="prefetch" href="/assets/js/6.2d0a63f8.js"><link rel="prefetch" href="/assets/js/7.399c2e3d.js"><link rel="prefetch" href="/assets/js/8.553d0e29.js"><link rel="prefetch" href="/assets/js/9.b74d6ce8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.87fd3165.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h1> <p><a href="https://www.kancloud.cn/manual/think-orm/content" target="_blank" rel="noopener noreferrer">手册<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="查寻"><a href="#查寻" class="header-anchor">#</a> 查寻</h2> <div class="language- extra-class"><pre class="language-text"><code>db_get(name,where,1); //取一条记录
db_get_one(name,where); //取一条记录
db_get(name,where); //取所有记录
</code></pre></div><p>其中<code>where</code>支持_id的值
或数组 ['name'=&gt;'admin']
或</p> <div class="language- extra-class"><pre class="language-text"><code>function($db)use($id){
    $db = $db-&gt;where('_id',$id);
    return $db;
}
</code></pre></div><h2 id="分页"><a href="#分页" class="header-anchor">#</a> 分页</h2> <div class="language- extra-class"><pre class="language-text"><code>db_pager(table_name,where)
</code></pre></div><h2 id="写入"><a href="#写入" class="header-anchor">#</a> 写入</h2> <div class="language- extra-class"><pre class="language-text"><code>db_insert(table_name,data)
</code></pre></div><h2 id="更新"><a href="#更新" class="header-anchor">#</a> 更新</h2> <div class="language- extra-class"><pre class="language-text"><code>db_update(table_name,data,where)
</code></pre></div><h2 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h2> <div class="language- extra-class"><pre class="language-text"><code>mongo_action(function(){

});
</code></pre></div><h2 id="where条件"><a href="#where条件" class="header-anchor">#</a> where条件</h2> <div class="language- extra-class"><pre class="language-text"><code>'status[!]'=&gt;['wait_pay','cancel'], not in
'status[!]'=&gt;'wait_pay', 不等于
'pay_method[~]'=&gt;'' //LIKE查寻
'pay_method'=&gt;['weixin'] //IN查寻
'amount[&gt;]'=&gt;32.16 
'amount[&gt;=]'=&gt;32.16 
'amount[&lt;]'=&gt;32.16 
'amount[&lt;=]'=&gt;32.16 
'amount[&lt;&gt;]'=&gt;[1,2] 在区间
'amount[&gt;&lt;]'=&gt;[1,2] 不在区间 
</code></pre></div><h2 id="group-having"><a href="#group-having" class="header-anchor">#</a> GROUP HAVING</h2> <p>由于think-orm没有对mongodb的group having做像mysql一样的支持。
无法通过<code>-&gt;group(...)</code>实现，本质是使用<code>aggregate</code>实现，为了方便使用，现已封装。</p> <p>支持<code>db_pager</code> <code>db_get</code></p> <ol><li><code>db_get</code></li></ol> <div class="language- extra-class"><pre class="language-text"><code>$d['list'] = db_get(&quot;hardware&quot;,[
     &quot;SUM(t)&quot;=&gt;'t',
     'min(t)'=&gt;'t1',
],[ 
  'drive[!]'=&gt;['gx'],
  'GROUP'=&gt; [
    'tag',
    'drive', 
  ],
  'HAVING'=&gt;[
      't[&gt;]'=&gt;0
  ],
  'ORDER'=&gt;[
    't'=&gt;'asc'
  ]
]);
</code></pre></div><ol start="2"><li><code>db_pager</code></li></ol> <div class="language- extra-class"><pre class="language-text"><code>$d['list'] = db_pager(&quot;hardware&quot;,[
     &quot;SUM(t)&quot;=&gt;'t',
     'min(t)'=&gt;'t1',
],[ 
  'drive[!]'=&gt;['gx'],
  'GROUP'=&gt; [
    'tag',
    'drive', 
  ],
  'HAVING'=&gt;[
      't[&gt;]'=&gt;0
  ],
  'ORDER'=&gt;[
    't'=&gt;'asc'
  ]
]);
</code></pre></div><p>除了<code>GROUP</code> <code>HAVING</code> <code>ORDER</code>其他参数对应<code>where</code></p> <p><code>GROUP</code>放在第一个</p> <h1 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h1> <h2 id="安装-mongodb-扩展"><a href="#安装-mongodb-扩展" class="header-anchor">#</a> 安装 mongodb 扩展</h2> <p>http://pecl.php.net/package/mongodb</p> <p>以php8.1为例</p> <div class="language- extra-class"><pre class="language-text"><code>wget http://pecl.php.net/get/mongodb-1.15.3.tgz
tar xvf mongodb-1.15.3.tgz
cd mongodb-1.15.3
phpize &amp;&amp; ./configure --with-php-config=/www/server/php/81/bin/php-config &amp;&amp; make &amp;&amp; make install
</code></pre></div><p>在<code>php.ini</code>最后加上</p> <div class="language- extra-class"><pre class="language-text"><code>extension=mongodb.so
</code></pre></div><h3 id="创建帐号"><a href="#创建帐号" class="header-anchor">#</a> 创建帐号</h3> <div class="language- extra-class"><pre class="language-text"><code>use admin
db.createUser({user:&quot;root&quot;,pwd:&quot;DoitT2023!ps&quot;,roles:[{role:&quot;userAdminAnyDatabase&quot;,db:&quot;admin&quot;},{role:&quot;clusterAdmin&quot;,db:&quot;admin&quot;},{role:&quot;root&quot;,db:&quot;admin&quot;}]})
</code></pre></div><h3 id="开启事务"><a href="#开启事务" class="header-anchor">#</a> 开启事务</h3> <ol><li>启动MongoDB实例并进入MongoDB shell</li></ol> <div class="language- extra-class"><pre class="language-text"><code>mongo -host=127.0.0.1 -port=10002
</code></pre></div><ol start="2"><li>在MongoDB shell中，切换到admin数据库</li></ol> <div class="language- extra-class"><pre class="language-text"><code>use admin
</code></pre></div><ol start="3"><li>启用事务
其中4.4是Mongo版本号</li></ol> <div class="language- extra-class"><pre class="language-text"><code>db.runCommand({ setFeatureCompatibilityVersion: &quot;4.4&quot; })
</code></pre></div><ol start="4"><li>配置副本集
在宝塔Mongo中配置文件配置</li></ol> <div class="language- extra-class"><pre class="language-text"><code>replication:
    replSetName: rs0  
</code></pre></div><ol start="5"><li>启动</li></ol> <div class="language- extra-class"><pre class="language-text"><code>rs.initiate()
</code></pre></div><ol start="6"><li>检测状态</li></ol> <div class="language- extra-class"><pre class="language-text"><code>rs.status()
</code></pre></div><p>如果使用分布式事务需要使用MongoDB的分片集群（Sharded Cluster）来实现</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f8d3940c.js" defer></script><script src="/assets/js/2.733019b2.js" defer></script><script src="/assets/js/12.ce7eb43c.js" defer></script>
  </body>
</html>
